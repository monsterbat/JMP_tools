// Export Non-Excluded Data to CSV
// åŒ¯å‡ºæœªè¢«æ’é™¤çš„è³‡æ–™ç‚º CSV æª”æ¡ˆ
// Editor: SC Hsiao
// Date: 2025-01-XX

// æª¢æŸ¥æ˜¯å¦æœ‰é–‹å•Ÿçš„è³‡æ–™è¡¨
if (N Table() == 0,
    Throw("è«‹å…ˆåœ¨ JMP ä¸­é–‹å•Ÿè³‡æ–™è¡¨")
);

// ç²å–ç•¶å‰è³‡æ–™è¡¨
dt = Current Data Table();

// ç²å–è³‡æ–™è¡¨åç¨±
table_name = dt << Get Name;

// ç²å–æ‰€æœ‰æœªè¢«æ’é™¤çš„åˆ—
excluded_rows = dt << Get Excluded Rows;
all_rows = 1 :: N Rows(dt);

// æ‰¾å‡ºæœªè¢«æ’é™¤çš„åˆ—
If(N Items(excluded_rows) == 0,
    row_states = all_rows;
,
    row_states = {};
    For(i = 1, i <= N Rows(dt), i++,
        is_excluded = 0;
        For(j = 1, j <= N Items(excluded_rows), j++,
            If(excluded_rows[j] == i,
                is_excluded = 1;
                Break();
            );
        );
        If(is_excluded == 0,
            Insert Into(row_states, i);
        );
    );
);

// æª¢æŸ¥æ˜¯å¦æœ‰è³‡æ–™å¯åŒ¯å‡º
if (N Items(row_states) == 0,
    Throw("æ‰€æœ‰è³‡æ–™åˆ—éƒ½è¢«æ’é™¤äº†ï¼Œæ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º")
);

// å–å¾—ç•¶å‰ JMP æª”æ¡ˆçš„å®Œæ•´è·¯å¾‘
jmp_file_path = dt << Get Path;

// æª¢æŸ¥æ˜¯å¦èƒ½å–å¾—æª”æ¡ˆè·¯å¾‘ï¼ˆå¦‚æœæª”æ¡ˆå°šæœªå„²å­˜æœƒæ˜¯ç©ºçš„ï¼‰
If(jmp_file_path == "",
    // å¦‚æœæª”æ¡ˆæœªå„²å­˜ï¼Œå­˜åˆ° Documents
    folder_path = "$DOCUMENTS/";
    Show("âš ï¸ JMP æª”æ¡ˆå°šæœªå„²å­˜ï¼Œå°‡å­˜åˆ° Documents è³‡æ–™å¤¾");
,
    // å¾å®Œæ•´è·¯å¾‘ä¸­æå–è³‡æ–™å¤¾è·¯å¾‘
    // æ‰¾åˆ°æœ€å¾Œä¸€å€‹ "/" çš„ä½ç½®
    last_slash_pos = 0;
    For(i = 1, i <= Length(jmp_file_path), i++,
        If(Substr(jmp_file_path, i, 1) == "/",
            last_slash_pos = i;
        );
    );
    
    // æå–è³‡æ–™å¤¾è·¯å¾‘ï¼ˆåŒ…å«æœ€å¾Œçš„ "/"ï¼‰
    folder_path = Substr(jmp_file_path, 1, last_slash_pos);
    Show("ğŸ“ JMP æª”æ¡ˆä½æ–¼: " || folder_path);
);

// ç”Ÿæˆæª”æ¡ˆåç¨±
clean_table_name = Substitute(table_name, ".jmp", "");
clean_table_name = Substitute(clean_table_name, " ", "_");
output_filename = clean_table_name || "_NonExcluded.csv";

// çµ„åˆå®Œæ•´çš„å„²å­˜è·¯å¾‘
save_path = folder_path || output_filename;

Show("ğŸ’¾ æª”æ¡ˆå°‡å„²å­˜åˆ°: " || save_path);

// å‰µå»ºåªåŒ…å«æœªæ’é™¤è³‡æ–™çš„æ–°è³‡æ–™è¡¨ï¼ˆä¸é¡¯ç¤ºè¦–çª—ï¼‰
dt_filtered = dt << Subset(
    Output Table Name("temp_filtered"),
    Rows(row_states),
    Selected Columns Only(0),  // åŒ…å«æ‰€æœ‰æ¬„ä½
    Invisible  // ä¸é¡¯ç¤ºæ–°è³‡æ–™è¡¨è¦–çª—
);

// ç›´æ¥åŒ¯å‡ºç‚º CSV
dt_filtered << Save As(
    save_path,
    "CSV"
);

// é—œé–‰è‡¨æ™‚è³‡æ–™è¡¨
dt_filtered << Close Window;

// åªé¡¯ç¤ºæœ€é‡è¦çš„æˆåŠŸè¨Šæ¯
Show("âœ… æˆåŠŸï¼æª”æ¡ˆå·²å„²å­˜åˆ°: " || save_path);

// é¡¯ç¤ºå®Œæˆå°è©±æ¡†
Dialog(
    Title("åŒ¯å‡ºå®Œæˆ"),
    Text Box("æˆåŠŸåŒ¯å‡ºæœªè¢«æ’é™¤çš„è³‡æ–™!"),
    Text Box(""),
    Text Box("æª”æ¡ˆä½ç½®: " || save_path),
    Text Box("è³‡æ–™åˆ—æ•¸: " || Char(N Items(row_states)) || " / " || Char(N Rows(dt))),
    Text Box(""),
    Text Box("ç¾åœ¨å¯ä»¥åœ¨ Best Fit(beta) ä¸­ä½¿ç”¨æ­¤ CSV æª”æ¡ˆé€²è¡Œåˆ†æ")
);
