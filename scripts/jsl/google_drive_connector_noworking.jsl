/*
	Google Drive æª”æ¡ˆé€£æ¥å™¨ (å®Œå…¨ä¿®æ­£ç‰ˆ)
	
	åŠŸèƒ½ï¼š
	1. å¾ Google Drive URL ä¸‹è¼‰æª”æ¡ˆ
	2. è‡ªå‹•é–‹å•Ÿä¸‹è¼‰çš„æª”æ¡ˆ
	3. æ”¯æ´å¤šç¨®æª”æ¡ˆæ ¼å¼ (CSV, Excel, JMP)
	
	ä½¿ç”¨æ–¹æ³•ï¼š
	1. ç¢ºä¿æª”æ¡ˆå·²è¨­å®šç‚ºã€Œä»»ä½•äººéƒ½å¯ä»¥æª¢è¦–ã€
	2. è¤‡è£½ Google Drive åˆ†äº«é€£çµ
	3. åŸ·è¡Œæ­¤è…³æœ¬ä¸¦è²¼ä¸Šé€£çµ
	
	ä½œè€…ï¼šData Analysis Tools
	ç‰ˆæœ¬ï¼š1.2 (å®Œå…¨ä¿®æ­£ç‰ˆ)
*/

// å¾ Google Drive URL æå–æª”æ¡ˆ ID
Extract_Google_Drive_File_ID = Function({url},
	{Default Local},
	
	// æ”¯æ´çš„ URL æ ¼å¼æ¨¡å¼
	patterns = {
		"/file/d/([a-zA-Z0-9-_]+)",  // https://drive.google.com/file/d/FILE_ID/view
		"id=([a-zA-Z0-9-_]+)",        // https://drive.google.com/open?id=FILE_ID
		"/d/([a-zA-Z0-9-_]+)/"        // å…¶ä»–æ ¼å¼
	};
	
	file_id = "";
	
	// å˜—è©¦æ¯å€‹æ¨¡å¼
	For(i = 1, i <= N Items(patterns), i++,
		pattern = patterns[i];
		
		// ä½¿ç”¨ Regex æå–æª”æ¡ˆ ID
		If(Regex(url, pattern) != {},
			matches = Regex(url, pattern);
			If(N Items(matches) >= 2,
				file_id = matches[2];
				Break();
			);
		);
	);
	
	Return(file_id);
);

// ä¸‹è¼‰ Google Drive æª”æ¡ˆ (ä¿®æ­£ç‰ˆ)
Download_Google_Drive_File = Function({url, target_dir},
	{Default Local},
	
	// æå–æª”æ¡ˆ ID
	file_id = Extract_Google_Drive_File_ID(url);
	
	If(file_id == "",
		Throw("ç„¡æ³•å¾ URL ä¸­æå– Google Drive æª”æ¡ˆ ID");
	);
	
	// è¨­å®šä¸‹è¼‰ç›®éŒ„
	If(Is Missing(target_dir) | target_dir == "",
		target_dir = Get Default Directory();
	);
	
	// å»ºç«‹ä¸‹è¼‰ URL
	download_url = "https://drive.google.com/uc?export=download&id=" || file_id;
	
	// è¨­å®šè¼¸å‡ºæª”æ¡ˆåç¨±ï¼ˆæš«æ™‚ä½¿ç”¨æª”æ¡ˆ IDï¼‰
	output_file = target_dir || "/" || file_id || "_downloaded_file";
	
	Write("æ­£åœ¨ä¸‹è¼‰ Google Drive æª”æ¡ˆ (ID: " || file_id || ")..." || "\!n");
	
	Try(
		// ä½¿ç”¨ JMP çš„ HTTP Get åŠŸèƒ½ä¸‹è¼‰æª”æ¡ˆ
		http_response = HTTP Get(download_url);
		
		If(http_response["status"] == 200,
			// å„²å­˜æª”æ¡ˆ
			file_content = http_response["body"];
			
			// å˜—è©¦æ ¹æ“šå›æ‡‰æ¨™é ­æ±ºå®šæª”æ¡ˆé¡å‹
			content_type = http_response["headers"]["Content-Type"];
			
			If(Contains(content_type, "text/csv"),
				output_file = output_file || ".csv";
			,Contains(content_type, "application/vnd.ms-excel") | Contains(content_type, "application/vnd.openxmlformats"),
				output_file = output_file || ".xlsx";
			,
				// é è¨­ç‚º CSV
				output_file = output_file || ".csv";
			);
			
			// å¯«å…¥æª”æ¡ˆ
			f = Create File(output_file);
			f << file_content;
			f << Close File;
			
			Write("âœ… æª”æ¡ˆä¸‹è¼‰æˆåŠŸ: " || output_file || "\!n");
			Return(output_file);
		,
			Throw("æª”æ¡ˆä¸‹è¼‰å¤±æ•—ï¼ŒHTTP ç‹€æ…‹ç¢¼: " || Char(http_response["status"]));
		);
	,
		// å¦‚æœ HTTP Get å¤±æ•—ï¼Œå˜—è©¦æ›¿ä»£æ–¹æ³•
		Write("âš ï¸  ç›´æ¥ä¸‹è¼‰å¤±æ•—ï¼Œè«‹å˜—è©¦æ‰‹å‹•ä¸‹è¼‰æ–¹æ³•\!n");
		Write("è«‹æ‰‹å‹•åŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿï¼š\!n");
		Write("1. é–‹å•Ÿç€è¦½å™¨ä¸¦å‰å¾€: " || download_url || "\!n");
		Write("2. ä¸‹è¼‰æª”æ¡ˆåˆ°æœ¬åœ°ç›®éŒ„\!n");
		Write("3. ä½¿ç”¨ JMP çš„æª”æ¡ˆé¸æ“‡å°è©±æ¡†é–‹å•Ÿä¸‹è¼‰çš„æª”æ¡ˆ\!n");
		
		Throw("è‡ªå‹•ä¸‹è¼‰å¤±æ•—ï¼Œè«‹ä½¿ç”¨æ‰‹å‹•ä¸‹è¼‰æ–¹æ³•");
	);
);

// ä¸»è¦çš„ Google Drive æª”æ¡ˆé–‹å•ŸåŠŸèƒ½
Open_Google_Drive_File = Function({},
	{Default Local},
	
	// å»ºç«‹è¼¸å…¥å°è©±æ¡†
	New Window("Google Drive æª”æ¡ˆé€£æ¥å™¨",
		V List Box(
			Text Box("è«‹è¼¸å…¥ Google Drive æª”æ¡ˆé€£çµï¼š"),
			Text Box(""),
			Text Box("æ”¯æ´çš„é€£çµæ ¼å¼ï¼š"),
			Text Box("â€¢ https://drive.google.com/file/d/FILE_ID/view?usp=sharing"),
			Text Box("â€¢ https://drive.google.com/file/d/FILE_ID/view?usp=drive_link"),
			Text Box("â€¢ https://drive.google.com/open?id=FILE_ID"),
			Text Box(""),
			Text Box("æ³¨æ„äº‹é …ï¼š"),
			Text Box("â€¢ è«‹ç¢ºä¿æª”æ¡ˆå·²è¨­å®šç‚ºã€Œä»»ä½•äººéƒ½å¯ä»¥æª¢è¦–ã€"),
			Text Box("â€¢ æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼šCSV, Excel, JMP"),
			Text Box("â€¢ æª”æ¡ˆå°‡æœƒä¸‹è¼‰åˆ°ç›®å‰å·¥ä½œç›®éŒ„"),
			Text Box(""),
			
			// URL è¼¸å…¥æ¡†
			H List Box(
				Text Box("Google Drive æª”æ¡ˆé€£çµ: "),
				Text Edit Box(
					"https://drive.google.com/file/d/119sslkCIIlacTa1gucenrweXI8EFJobZ/view?usp=drive_link",
					<<Set Width(500),
					<<Set Name("url_input")
				)
			),
			Text Box(""),
			
			// ç‹€æ…‹é¡¯ç¤º
			Text Box("æº–å‚™å°±ç·’", <<Set Name("status_box")),
			Text Box(""),
			
			// æŒ‰éˆ•
			H List Box(
				Button Box("ä¸‹è¼‰ä¸¦é–‹å•Ÿæª”æ¡ˆ",
					// ç²å– URL è¼¸å…¥
					url_input_box = Current Window()["url_input"];
					url = url_input_box << Get Text;
					
					// ç²å–ç‹€æ…‹é¡¯ç¤ºæ¡†
					status_box = Current Window()["status_box"];
					
					If(url == "",
						status_box << Set Text("âŒ è«‹è¼¸å…¥ Google Drive æª”æ¡ˆé€£çµ");
						Return();
					);
					
					Try(
						status_box << Set Text("ğŸ”„ æ­£åœ¨ä¸‹è¼‰æª”æ¡ˆ...");
						
						// ä¸‹è¼‰æª”æ¡ˆ
						downloaded_file = Download_Google_Drive_File(url, "");
						
						status_box << Set Text("ğŸ“‚ æª”æ¡ˆä¸‹è¼‰å®Œæˆï¼Œæ­£åœ¨é–‹å•Ÿ...");
						
						// é–‹å•Ÿæª”æ¡ˆ
						Open(downloaded_file);
						
						status_box << Set Text("âœ… æª”æ¡ˆå·²æˆåŠŸé–‹å•Ÿï¼");
						
						// é¡¯ç¤ºæˆåŠŸè¨Šæ¯
						success_msg = "âœ… Google Drive æª”æ¡ˆå·²æˆåŠŸé–‹å•Ÿï¼\!n\!n";
						success_msg ||= "æª”æ¡ˆä½ç½®: " || downloaded_file || "\!n";
						success_msg ||= "æ‚¨ç¾åœ¨å¯ä»¥åœ¨ JMP ä¸­ä½¿ç”¨é€™å€‹æª”æ¡ˆã€‚";
						
						New Window("æˆåŠŸ", Text Box(success_msg));
					,
						status_box << Set Text("âŒ ä¸‹è¼‰å¤±æ•—: " || Exception Message);
						
						// æä¾›æ‰‹å‹•ä¸‹è¼‰èªªæ˜
						manual_msg = "è‡ªå‹•ä¸‹è¼‰å¤±æ•—ï¼Œå»ºè­°ä½¿ç”¨æ‰‹å‹•æ–¹å¼ï¼š\!n\!n";
						manual_msg ||= "1. è¤‡è£½ä»¥ä¸‹é€£çµåˆ°ç€è¦½å™¨ï¼š\!n";
						manual_msg ||= "   " || url || "\!n\!n";
						manual_msg ||= "2. é»æ“Šã€Œä¸‹è¼‰ã€æŒ‰éˆ•\!n";
						manual_msg ||= "3. å°‡æª”æ¡ˆå„²å­˜åˆ°æœ¬åœ°ç›®éŒ„\!n";
						manual_msg ||= "4. ä½¿ç”¨ æª”æ¡ˆ â†’ é–‹å•Ÿ ä¾†é–‹å•Ÿä¸‹è¼‰çš„æª”æ¡ˆ\!n\!n";
						manual_msg ||= "å¸¸è¦‹å•é¡Œï¼š\!n";
						manual_msg ||= "â€¢ ç¢ºä¿æª”æ¡ˆæ¬Šé™è¨­å®šç‚ºã€Œä»»ä½•äººéƒ½å¯ä»¥æª¢è¦–ã€\!n";
						manual_msg ||= "â€¢ æª¢æŸ¥ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸\!n";
						manual_msg ||= "â€¢ å¦‚æœæ˜¯å¤§å‹æª”æ¡ˆï¼Œå»ºè­°ä½¿ç”¨ç€è¦½å™¨ä¸‹è¼‰";
						
						New Window("æ‰‹å‹•ä¸‹è¼‰èªªæ˜", Text Box(manual_msg));
					);
				),
				
				Button Box("å–æ¶ˆ",
					Current Window() << Close Window;
				),
				
				Button Box("èªªæ˜",
					help_msg = "Google Drive æª”æ¡ˆé€£æ¥å™¨ä½¿ç”¨èªªæ˜\!n\!n";
					help_msg ||= "ğŸ”— æ”¯æ´çš„é€£çµæ ¼å¼ï¼š\!n";
					help_msg ||= "â€¢ åˆ†äº«é€£çµ (view?usp=sharing)\!n";
					help_msg ||= "â€¢ ç›´æ¥é€£çµ (view?usp=drive_link)\!n";
					help_msg ||= "â€¢ èˆŠç‰ˆé€£çµ (open?id=FILE_ID)\!n\!n";
					help_msg ||= "ğŸ“ æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼š\!n";
					help_msg ||= "â€¢ CSV æª”æ¡ˆ (.csv)\!n";
					help_msg ||= "â€¢ Excel æª”æ¡ˆ (.xlsx, .xls)\!n";
					help_msg ||= "â€¢ JMP æª”æ¡ˆ (.jmp)\!n\!n";
					help_msg ||= "âš™ï¸  è¨­å®šè¦æ±‚ï¼š\!n";
					help_msg ||= "â€¢ æª”æ¡ˆå¿…é ˆè¨­å®šç‚ºã€Œä»»ä½•äººéƒ½å¯ä»¥æª¢è¦–ã€\!n";
					help_msg ||= "â€¢ éœ€è¦ç¶²è·¯é€£ç·š\!n";
					help_msg ||= "â€¢ JMP ç‰ˆæœ¬éœ€æ”¯æ´ HTTP åŠŸèƒ½\!n\!n";
					help_msg ||= "ğŸ› ï¸  æ•…éšœæ’é™¤ï¼š\!n";
					help_msg ||= "â€¢ å¦‚æœè‡ªå‹•ä¸‹è¼‰å¤±æ•—ï¼Œè«‹ä½¿ç”¨æ‰‹å‹•ä¸‹è¼‰\!n";
					help_msg ||= "â€¢ æª¢æŸ¥ Google Drive æª”æ¡ˆæ¬Šé™è¨­å®š\!n";
					help_msg ||= "â€¢ ç¢ºèªé€£çµæ ¼å¼æ­£ç¢º";
					
					New Window("ä½¿ç”¨èªªæ˜", Text Box(help_msg));
				)
			)
		)
	);
);

// ç°¡åŒ–ç‰ˆæœ¬ - ç›´æ¥è™•ç†ç‰¹å®šé€£çµ
Process_Specific_Google_Drive_File = Function({},
	{Default Local},
	
	// æ‚¨æä¾›çš„ç‰¹å®šé€£çµ
	google_drive_url = "https://drive.google.com/file/d/119sslkCIIlacTa1gucenrweXI8EFJobZ/view?usp=drive_link";
	
	Write("è™•ç†ç‰¹å®šçš„ Google Drive æª”æ¡ˆ...\!n");
	Write("é€£çµ: " || google_drive_url || "\!n");
	
	Try(
		downloaded_file = Download_Google_Drive_File(google_drive_url, "");
		Open(downloaded_file);
		
		Write("âœ… æª”æ¡ˆè™•ç†å®Œæˆï¼\!n");
	,
		Write("âŒ æª”æ¡ˆè™•ç†å¤±æ•—: " || Exception Message || "\!n");
		
		// æä¾›æ‰‹å‹•ä¸‹è¼‰é€£çµ
		direct_download_url = "https://drive.google.com/uc?export=download&id=119sslkCIIlacTa1gucenrweXI8EFJobZ";
		Write("è«‹å˜—è©¦æ‰‹å‹•ä¸‹è¼‰: " || direct_download_url || "\!n");
	);
);

// åŸ·è¡Œä¸»è¦åŠŸèƒ½
// å–æ¶ˆè¨»è§£ä¸‹é¢ä»»ä¸€è¡Œä¾†åŸ·è¡Œç›¸æ‡‰åŠŸèƒ½ï¼š

// é–‹å•Ÿé€šç”¨ Google Drive æª”æ¡ˆå°è©±æ¡†
Open_Google_Drive_File();

// æˆ–è€…ç›´æ¥è™•ç†æ‚¨æä¾›çš„ç‰¹å®šæª”æ¡ˆ
// Process_Specific_Google_Drive_File();

Write("Google Drive æª”æ¡ˆé€£æ¥å™¨è¼‰å…¥å®Œæˆ\!n");
Write("ä½¿ç”¨ Open_Google_Drive_File() ä¾†é–‹å•Ÿé€šç”¨å°è©±æ¡†\!n");
Write("ä½¿ç”¨ Process_Specific_Google_Drive_File() ä¾†è™•ç†ç‰¹å®šæª”æ¡ˆ\!n"); 